<!DOCTYPE html>
<html>
  <head>
    <title>Flask App</title>
    <style>
      body {
        background-color: #fff;
        font-family: Calibri, sans-serif;
      }
      #form-container {
        width: 60%;
        margin: 0 auto;
        text-align: center;
      }
      #content {
        display: flex;
        justify-content: center;
      }
      #table-container {
        width: 40%;
        max-height: 600px;
        overflow-y: auto;
        margin-left: 20px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th, td {
        border: 1px solid #ccc;
        padding: 8px;
        text-align: left;
      }
      th {
        background-color: #f2f2f2;
        font-weight: bold;
      }
      tr:nth-child(even) {
        background-color: #f2f2f2;
      }
      label {
        display: block;
        margin-bottom: 10px;
        font-size: 18px;
        font-weight: bold;
      }
      input[type=text] {
        padding: 10px;
        border-radius: 5px;
        border: none;
        width: 100%;
        box-sizing: border-box;
        background-color: #f7f7f7;
        font-family: Calibri, sans-serif;
        font-size: 16px;
      }
      #api_key {
        border-top-left-radius: 5px;
        border-top-right-radius: 5px;
      }
      #prompt {
        border-bottom-left-radius: 5px;
        border-bottom-right-radius: 5px;
      }
      #plot-img {
      display: block;
      margin: 0 auto;
      margin-top: 20px;
      }
      .plot-and-code {
        display: flex;
        justify-content: center;
        align-items: flex-start;
        gap: 20px;
      }
      #code-container {
        font-family: "Courier New", monospace;
        white-space: pre-wrap;
        background-color: #f7f7f7;
        border: 1px solid #ccc;
        padding: 10px;
        border-radius: 5px;
        overflow: auto;
      }
      .button-group {
        text-align: center;
        margin-bottom: 20px;
      }

      .custom-btn {
        font-family: Calibri, sans-serif;
        font-size: 16px;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        background-color: #007bff;
        color: #fff;
        cursor: pointer;
        transition: background-color 0.3s;
      }

      .custom-btn:hover {
        background-color: #0056b3;
      }

      .upload-btn {
        margin-left: 10px;
      }
      .custom-file-input-container {
        display: inline-block;
        width: auto;
        text-align: center;
      }


    </style>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> 
  </head>
  <body>
    <div id="form-container">
      <form id="prompt-form" method="POST" action="/submit">
        <label for="api_key" style="font-size: 24px; margin-bottom: 20px;">API Key:</label>
        <input type="text" id="api_key" name="api_key" value="Enter your API key here..." onFocus="if(this.value=='Enter your API key here...')this.value='';" onBlur="if(this.value=='')this.value='Enter your API key here...';"><br>

        <label for="prompt" style="font-size: 24px; margin-bottom: 20px;">Prompt:</label>
        <input type="text" id="prompt" name="prompt" value="Enter your prompt here..." onFocus="if(this.value=='Enter your prompt here...')this.value='';" onBlur="if(this.value=='')this.value='Enter your prompt here...';"><br>
      </form>
    </div>

    <div class="button-group">
      <button id="reset-btn" class="btn btn-secondary custom-btn">Reset</button>
    </div>

    <div id="csv-upload-container">
      <form id="csv-upload-form" method="POST" action="/upload_csv" enctype="multipart/form-data">
        <div class="button-group">
          <label style="font-size: 24px; margin-bottom: 20px;">Upload CSV File:</label>
          <div class="custom-file-input-container">
            <input type="file" id="csv_file" name="csv_file" accept=".csv" style="display:none;">
            <label class="custom-btn" id="choose-file-label">Choose File</label>
          </div>
          <button type="button" id="upload-btn" class="custom-btn upload-btn">Upload</button>
        </div>
        
      </form>
    </div>
    
    <div class="button-group">
      <button id="submit_btn" class="custom-btn">Submit</button>
    </div>

    <div class="plot-and-code">
      {% if plot_data %}
      <img id="plot-img" src="data:image/png;base64,{{ plot_data }}" alt="Plot">
      {% endif %}
      
      <pre id="code-container">
        {% if code_data %}
        {{ code_data | safe }}
        {% endif %}
      </pre>
    </div>
    <div id="content">
      <div id="table-container">
        <table>
          <thead>
            <tr>
              {% if csv_data %}
              {% for header in csv_data[0].keys() %}
              <th>{{ header }}</th>
              {% endfor %}
              {% endif %}
            </tr>
          </thead>
          <tbody>
            {% for row in csv_data %}
            <tr>
              {% for cell in row.values() %}
              <td>{{ cell }}</td>
              {% endfor %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    <script>
      document.getElementById("reset-btn").addEventListener("click", function () {
          // Send a POST request to the /reset route
          fetch('/reset', { method: 'POST' })
              .then((response) => {
                  if (response.ok) {
                      // Clear the table
                      document.querySelector("#table-container table tbody").innerHTML = "";
                      // Clear the visualization
                      document.getElementById("plot-img").src = "";
                      // Clear the code display
                      document.getElementById("code-container").innerHTML = "";
                      // Clear the prompt input field
                      document.getElementById("prompt").value = "";
                      document.getElementById("prompt").placeholder = "Enter your prompt here...";
                  } else {
                      console.error("Failed to reset the visualization and data");
                  }
              })
              .catch((error) => {
                  console.error("Error:", error);
              });
      });
    </script>
    <script>
      $("#upload-btn").on("click", function() {
        var formData = new FormData($("#csv-upload-form")[0]);
        $.ajax({
          url: "/upload_csv",
          method: "POST",
          data: formData,
          processData: false,
          contentType: false,
          success: function(data) {
            if (data) {
              // Update the table-container with the new table HTML
              $("#table-container").html(data);
            } else {
              alert("Please upload a valid CSV file.");
            }
          },
          error: function(xhr, status, error) {
            alert("Error uploading CSV file: " + xhr.responseText);
          }
        });
      });
    </script>
    <script>
      document.getElementById("prompt-form").addEventListener("submit", function() {
      // Store the API key in local storage
      localStorage.setItem("api_key", document.getElementById("api_key").value);
      });
    </script>
    <script>
      function setApiKeyFromLocalStorage() {
        // Check if the API key is stored in local storage
        const apiKey = localStorage.getItem("api_key");
        if (apiKey) {
          // Set the value of the API key input field
          document.getElementById("api_key").value = apiKey;
        }

          // Check if the last prompt is stored in local storage
        const lastPrompt = localStorage.getItem("last_prompt");
        if (lastPrompt) {
          // Set the value of the prompt input field
          document.getElementById("prompt").placeholder = lastPrompt;
        }
      }
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", setApiKeyFromLocalStorage);
    </script>
    <script>
      $('#submit_btn').on('click', function(e) {
        e.preventDefault(); // Prevent default form submission
        localStorage.setItem("api_key", document.getElementById("api_key").value);
        localStorage.setItem("last_prompt", document.getElementById("prompt").value); // Store the prompt value
        $('#prompt-form').submit();
      });
    </script>
    <script>
      document.getElementById("choose-file-label").addEventListener("click", function() {
        document.getElementById("csv_file").click();
      });
    </script>
    <script>
      $("#csv_file").on("change", function() {
        const fileName = $(this).val().split("\\").pop();
        $(this)
        .next("label")
        .html(fileName.length > 0 ? fileName : "Choose File");
      });
    </script>

  </body>
</html>
